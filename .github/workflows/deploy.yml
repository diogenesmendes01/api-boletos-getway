name: Deploy API Boletos Gateway

on:
  push:
    branches: 
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: diogenesmendes01/api-boletos-getway
  VPS_IP: 168.231.92.229

jobs:
  test:
    name: Testes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependÃªncias
        run: npm ci || npm install

      - name: Executar testes
        run: npm test || echo "Testes nÃ£o configurados"
        continue-on-error: true

      - name: Build do projeto
        run: npm run build || echo "Build realizado no Docker"

  build-and-push:
    name: Build e Push Docker
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Metadata da imagem
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}

      - name: Build e Push da imagem Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

  deploy:
    name: Deploy na VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "================================================"
            echo "ğŸš€ INICIANDO DEPLOY - API BOLETOS GATEWAY"
            echo "================================================"
            echo ""
            
            # ConfiguraÃ§Ãµes
            PROJECT_DIR="~/projetos/api-boleto"
            IMAGE_NAME="ghcr.io/${{ env.IMAGE_NAME }}:latest"
            
            # Criar diretÃ³rios necessÃ¡rios
            echo "ğŸ“ Preparando diretÃ³rios..."
            mkdir -p ${PROJECT_DIR}/{logs,uploads,backups}
            cd ${PROJECT_DIR}
            
            # Criar arquivo .env se nÃ£o existir
            if [ ! -f .env ]; then
              echo "ğŸ“ Criando arquivo .env..."
              cat > .env << 'ENVEOF'
            # SeguranÃ§a - ALTERE ESTAS SENHAS!
            JWT_SECRET=jwt_super_secret_olympia_2024_change_this_now
            API_KEY=api_key_super_secret_olympia_2024_change_this_now
            
            # Outras configuraÃ§Ãµes
            LOG_LEVEL=info
            ENVEOF
              echo "âš ï¸  Arquivo .env criado. Por favor, edite as senhas!"
            fi
            
            # Fazer backup do docker-compose atual
            if [ -f docker-compose.prod.yml ]; then
              cp docker-compose.prod.yml docker-compose.prod.yml.backup
              echo "ğŸ’¾ Backup do docker-compose.prod.yml criado"
            fi
            
            # Login no GitHub Container Registry (se token configurado)
            if [ ! -z "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "ğŸ” Fazendo login no GHCR..."
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            fi
            
            # Baixar imagem mais recente
            echo "ğŸ“¦ Baixando imagem Docker..."
            if docker pull ${IMAGE_NAME}; then
              echo "âœ… Imagem baixada com sucesso"
            else
              echo "âŒ Erro ao baixar imagem do GHCR"
              echo "Tentando build local como fallback..."
              
              # Clonar cÃ³digo se necessÃ¡rio
              if [ ! -d "source" ]; then
                git clone https://github.com/${{ github.repository }}.git source
              fi
              cd source && git pull origin main
              
              # Build local
              docker build -t api-boleto-local .
              IMAGE_NAME="api-boleto-local"
              cd ${PROJECT_DIR}
            fi
            
            # Criar docker-compose.prod.yml com configuraÃ§Ã£o completa
            echo "ğŸ“ Criando docker-compose.prod.yml..."
            cat > docker-compose.prod.yml << 'DOCKEREOF'
           version: '3.8'

services:
  api-boleto:
    image: ghcr.io/diogenesmendes01/api-boletos-getway:latest
    container_name: api-boleto-olympia
    restart: always
    command: node dist/src/main.js
    ports:
      - "127.0.0.1:3001:3000"
    environment:
      NODE_ENV: production
      PORT: "3000"
      
      # ===== BANCO DE DADOS =====
      DB_HOST: postgres-olympia
      DB_PORT: "5432"
      DB_USERNAME: olympia_app
      DB_PASSWORD: V/aMMGypweFPSlGivTdcaC44zzEZDfuv
      DB_DATABASE: boleto_db
      
      # ===== TYPEORM =====
      TYPEORM_CONNECTION: postgres
      TYPEORM_HOST: postgres-olympia
      TYPEORM_PORT: "5432"
      TYPEORM_USERNAME: olympia_app
      TYPEORM_PASSWORD: V/aMMGypweFPSlGivTdcaC44zzEZDfuv
      TYPEORM_DATABASE: boleto_db
      TYPEORM_SYNCHRONIZE: "false"
      TYPEORM_LOGGING: "true"
      TYPEORM_ENTITIES: dist/src/entities/*.entity.js
      TYPEORM_MIGRATIONS: dist/src/migrations/*.js
      TYPEORM_MIGRATIONS_DIR: src/migrations
      TYPEORM_ENTITIES_DIR: src/entities
      TYPEORM_MIGRATIONS_TABLE_NAME: migrations
      TYPEORM_MIGRATIONS_RUN: "true"
      
      # ===== REDIS (IMPORTANTE!) =====
      REDIS_URL: redis://redis-boleto:6379
      
      # ===== SEGURANÃ‡A =====
      JWT_SECRET: jwt_olympia_secret_change_this_2024
      API_KEY: api_key_olympia_change_this_2024
      
      # ===== OUTROS =====
      CORS_ORIGINS: https://envio-boleto.olympiabank.xyz
      LOG_LEVEL: debug
      
    networks:
      - proxy-network
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - redis-boleto
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ADICIONAR REDIS
  redis-boleto:
    image: redis:7-alpine
    container_name: redis-boleto
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  redis_data:

networks:
  proxy-network:
    external: true
            DOCKEREOF
            
            # Substituir variÃ¡vel IMAGE_NAME no docker-compose
            sed -i "s|\${IMAGE_NAME}|${IMAGE_NAME}|g" docker-compose.prod.yml
            
            # Garantir que postgres-olympia estÃ¡ na rede correta
            echo "ğŸ”— Verificando conexÃ£o de rede..."
            docker network connect proxy-network postgres-olympia 2>/dev/null || echo "postgres-olympia jÃ¡ conectado Ã  proxy-network"
            
            # Parar container antigo
            echo "ğŸ›‘ Parando container antigo..."
            docker compose -f docker-compose.prod.yml down || true
            docker rm -f api-boleto-olympia || true   # <<< ÃšNICA LINHA ADICIONADA
            
            # Limpar volumes Ã³rfÃ£os
            docker volume prune -f 2>/dev/null || true
            
            # Subir novo container
            echo "ğŸš€ Iniciando novo container..."
            docker compose -f docker-compose.prod.yml up -d --force-recreate
            
            # Aguardar inicializaÃ§Ã£o
            echo "â³ Aguardando inicializaÃ§Ã£o (30 segundos)..."
            sleep 30
            
            # Verificar status
            echo "ğŸ” Verificando status do deploy..."
            if docker ps | grep -q api-boleto-olympia; then
              echo ""
              echo "================================================"
              echo "âœ… CONTAINER RODANDO COM SUCESSO!"
              echo "================================================"
              
              # InformaÃ§Ãµes do container
              echo "ğŸ“Š Status do container:"
              docker ps | grep api-boleto-olympia
              
              # Testar health check
              echo ""
              echo "ğŸ¥ Testando health check..."
              if curl -f -s http://localhost:3001/health > /dev/null 2>&1; then
                echo "âœ… Health check respondendo!"
                curl -s http://localhost:3001/health | head -20
              else
                echo "âš ï¸ Health check nÃ£o estÃ¡ respondendo ainda"
                echo "Aguarde mais alguns segundos ou verifique os logs"
              fi
              
              # Mostrar Ãºltimos logs
              echo ""
              echo "ğŸ“‹ Ãšltimos logs do container:"
              echo "================================================"
              docker logs --tail 50 api-boleto-olympia
              echo "================================================"
              
              # Verificar se migrations rodaram
              echo ""
              echo "ğŸ—„ï¸ Verificando migrations..."
              docker exec postgres-olympia psql -U olympia_app -d boleto_db -c "\dt" 2>/dev/null | head -20 || echo "NÃ£o foi possÃ­vel verificar tabelas"
              
              # InformaÃ§Ãµes finais
              echo ""
              echo "================================================"
              echo "ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!"
              echo "================================================"
              echo "ğŸ“ URL Local: http://localhost:3001"
              echo "ğŸŒ URL PÃºblica: https://api.envio-boleto.olympiabank.xyz"
              echo "ğŸ“ LocalizaÃ§Ã£o: ${PROJECT_DIR}"
              echo "ğŸ³ Container: api-boleto-olympia"
              echo "ğŸ“ Logs: docker logs -f api-boleto-olympia"
              echo "================================================"
              
            else
              echo ""
              echo "================================================"
              echo "âŒ ERRO: CONTAINER NÃƒO ESTÃ RODANDO!"
              echo "================================================"
              echo "ğŸ“‹ Logs de erro:"
              docker logs api-boleto-olympia --tail 100
              echo ""
              echo "ğŸ”§ Tentando diagnosticar o problema..."
              docker ps -a | grep api-boleto
              echo ""
              echo "ğŸ’¡ SugestÃµes:"
              echo "1. Verifique os logs: docker logs api-boleto-olympia"
              echo "2. Verifique a conexÃ£o com o banco: docker exec api-boleto-olympia ping postgres-olympia"
              echo "3. Verifique as variÃ¡veis de ambiente: docker exec api-boleto-olympia env"
              exit 1
            fi
            
            # Limpar imagens antigas
            echo ""
            echo "ğŸ§¹ Limpando imagens antigas..."
            docker image prune -f
            
            echo ""
            echo "âœ… Script de deploy finalizado!"